name: Terraform CI

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**.tf'
      - '**.tfvars'
      - '.github/workflows/terraform-ci.yml'

env:
  TF_VERSION: 1.7.0
  TFLINT_VERSION: v0.50.0
  TFSEC_VERSION: v1.28.4

jobs:
  terraform-check:
    name: Terraform Format & Validate
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, stg, prod]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        working-directory: environments/${{ matrix.environment }}
        run: terraform init -backend=false

      - name: Terraform Validate
        id: validate
        working-directory: environments/${{ matrix.environment }}
        run: terraform validate -no-color

      - name: Comment Format Issues
        if: steps.fmt.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **Terraform Format Check Failed** for `${{ matrix.environment }}`\n\nPlease run `terraform fmt -recursive` locally.'
            })

      - name: Post validation status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### Terraform Format and Style ğŸ–Œ\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization âš™ï¸\`${{ steps.init.outcome }}\`
            #### Terraform Validation ğŸ¤–\`${{ steps.validate.outcome }}\`
            
            *Environment: \`${{ matrix.environment }}\`*
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  tflint:
    name: TFLint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache TFLint plugins
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: tflint-${{ hashFiles('.tflint.hcl') }}

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: Init TFLint
        run: tflint --init

      - name: Run TFLint on modules
        run: |
          for dir in modules/*/; do
            echo "Linting $dir"
            cd "$dir"
            tflint --config ../../.tflint.hcl || exit 1
            cd -
          done

      - name: Run TFLint on environments
        run: |
          for dir in environments/*/; do
            echo "Linting $dir"
            cd "$dir"
            tflint --config ../../.tflint.hcl || exit 1
            cd -
          done

  tfsec:
    name: TFSec Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          version: ${{ env.TFSEC_VERSION }}
          soft_fail: false
          format: sarif
          additional_args: --minimum-severity MEDIUM

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: tfsec.sarif

  checkov:
    name: Checkov Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: terraform
          soft_fail: false
          skip_check: CKV_TF_1  # Skip module source versioning for local modules

  terraform-docs:
    name: Terraform Docs Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup terraform-docs
        uses: terraform-docs/gh-actions@v1.0.0
        with:
          working-dir: modules
          output-file: README.md
          output-method: inject
          git-push: false
          fail-on-diff: true

  plan-dev:
    name: Terraform Plan (Dev)
    runs-on: ubuntu-latest
    needs: [terraform-check, tflint]
    if: github.event.pull_request.base.ref == 'develop' || github.event.pull_request.base.ref == 'main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: environments/dev
        run: terraform init -backend=false

      - name: Terraform Plan
        working-directory: environments/dev
        run: |
          # Create a minimal tfvars for plan (doesn't execute, just validates)
          cat > terraform.tfvars <<EOF
          target_provider = "vps"
          vps_host = "1.2.3.4"
          letsencrypt_email = "devops@example.com"
          EOF
          
          terraform plan -no-color -out=tfplan 2>&1 | tee plan.txt
        continue-on-error: true

      - name: Comment Plan
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('environments/dev/plan.txt', 'utf8');
            const truncatedPlan = plan.length > 60000 ? plan.substring(0, 60000) + '\n...\n**Plan output truncated**' : plan;
            
            const output = `#### Terraform Plan (Dev) ğŸ“–
            <details><summary>Show Plan</summary>
            
            \`\`\`terraform
            ${truncatedPlan}
            \`\`\`
            
            </details>
            
            *Pusher: @${{ github.actor }}*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [terraform-check, tflint, tfsec, checkov]
    if: always()
    
    steps:
      - name: Post Summary
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## Terraform CI Summary
            
            | Check | Status |
            |-------|--------|
            | Format & Validate | ${{ needs.terraform-check.result == 'success' && 'âœ…' || 'âŒ' }} |
            | TFLint | ${{ needs.tflint.result == 'success' && 'âœ…' || 'âŒ' }} |
            | TFSec | ${{ needs.tfsec.result == 'success' && 'âœ…' || 'âŒ' }} |
            | Checkov | ${{ needs.checkov.result == 'success' && 'âœ…' || 'âŒ' }} |
            
            ${{ needs.terraform-check.result == 'success' && needs.tflint.result == 'success' && needs.tfsec.result == 'success' && needs.checkov.result == 'success' && 'âœ… **All checks passed!**' || 'âŒ **Some checks failed. Please review above.**' }}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            })

